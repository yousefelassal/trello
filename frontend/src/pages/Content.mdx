<h1 className="text-4xl py-2 font-bold">Documentation</h1>

<h2 className="text-2xl font-semibold">Client State</h2>

A custom hook was created to get the user token on first render from local storage and set the token value on login and signup using `jotai` util <span className="underline">[`atomWithStorage`](https://jotai.org/docs/utilities/storage)</span>

<CH.Code>

```ts useTokenValue.ts mark=4[20:34],7[29:35]
import { useAtom } from "jotai";
import { atomWithStorage } from "jotai/utils";

const tokenValue = atomWithStorage<string | null>('trello-3al-daya2-token', null)

export const useTokenValue = () => {
  const [token, setToken] = useAtom(tokenValue)

  return {
    token,
    setToken
  }
}
```

```tsx App.tsx focus=1,4,6[7:12],14,15
import { useTokenValue } from "./hooks/useTokenValue";

function App() {
  const { token, setToken } = useTokenValue()

  if (token) {
    return (
      // user is logged in and dashboard is rendered
    )
  }

  return (
    // user is not logged in and landing page is rendered with login and signup
      <Route path="/login" element={<Login setToken={setToken} />} />
      <Route path="/signup" element={<Signup setToken={setToken} />} />
  );
}

```

</CH.Code>

<h2 className="text-2xl font-semibold">Server State</h2>

Server state was handled using <span className="underline">[Apollo Client](https://www.apollographql.com/docs/react/)</span>

<CH.Section>

```tsx main.tsx
import ReactDOM from 'react-dom/client'
import ApolloProvider from './components/ApolloProvider.tsx'

ReactDOM.createRoot(document.getElementById('root')!).render(
  <ApolloProvider>
    <Router>
      <App />
    </Router>
  </ApolloProvider>
)
```
A custom [ApolloProvider](focus://2,5,9) component was created to wrap the app with the apollo client and set the authorization header with the user token from local storage

</CH.Section>

<br />


<CH.Scrollycoding>

<h3 className="text-lg font-semibold">Using Token</h3>

`useTokenValue` is imported and used to get the user token

```tsx ApolloProvider.tsx focus=1,8
import { useTokenValue } from '@/hooks/useTokenValue'

interface Props {
  children: React.ReactNode
}

const ApolloProvider = ({children}:Props) => {
  const { token } = useTokenValue()

  const httpLink = createHttpLink({
    uri: import.meta.env.VITE_SERVER,
  })
  
  const client = new ApolloClient({
    cache: new InMemoryCache(),
    link: authLink.concat(httpLink),
  })

  return (
    <Provider client={client}>
      {children}
    </Provider>
  )
}

export default ApolloProvider
```

---

<h3 className="text-lg font-semibold">User Context</h3>

`setContext` is used to set the authorization header with the user token


```tsx ApolloProvider.tsx focus=1,10:17
import { setContext } from '@apollo/client/link/context'
import { useTokenValue } from '@/hooks/useTokenValue'

interface Props {
  children: React.ReactNode
}

const ApolloProvider = ({children}:Props) => {
  const { token } = useTokenValue()
  const authLink = setContext((_, { headers }) => {
    return {
        headers: {
          ...headers,
          authorization: token ? `Bearer ${token}` : null,
        }
    }
  })
  const httpLink = createHttpLink({
    uri: import.meta.env.VITE_SERVER,
  })
  
  const client = new ApolloClient({
    cache: new InMemoryCache(),
    link: authLink.concat(httpLink),
  })

  return (
    <Provider client={client}>
      {children}
    </Provider>
  )
}

export default ApolloProvider
```

---

<h3 className="text-lg font-semibold">Apollo Client</h3>

The apollo client is created with the `authLink` created and `httpLink` from the server uri which is set in the `.env` file according to the environment (development or production)

<CH.Code>

```tsx ApolloProvider.tsx focus=1:6,24:37
import {
  ApolloClient,
  ApolloProvider as Provider,
  InMemoryCache,
  createHttpLink,
} from '@apollo/client'
import { setContext } from '@apollo/client/link/context'
import { useTokenValue } from '@/hooks/useTokenValue'

interface Props {
  children: React.ReactNode
}

const ApolloProvider = ({children}:Props) => {
  const { token } = useTokenValue()
  const authLink = setContext((_, { headers }) => {
    return {
        headers: {
          ...headers,
          authorization: token ? `Bearer ${token}` : null,
        }
    }
  })
  const httpLink = createHttpLink({
    uri: import.meta.env.VITE_SERVER,
  })
  
  const client = new ApolloClient({
    cache: new InMemoryCache(),
    link: authLink.concat(httpLink),
  })

  return (
    <Provider client={client}>
      {children}
    </Provider>
  )
}

export default ApolloProvider
```

---

```env .env
VITE_SERVER=http://localhost:4000/graphql
```

</CH.Code>


</CH.Scrollycoding>

<h2 className="text-2xl font-semibold">Creating a new Board</h2>

<br />

<img
  src="https://utfs.io/f/6eab8aeb-9a8f-429d-85b6-d80f88a18c53-74p8et.PNG"
  alt="Create Board Modal"
  className="rounded-lg shadow-lg"
/>

<h3 className="text-lg font-semibold">Unsplash API</h3> 

Custom hook `useRandomPhotos` is created to fetch random photos from <span className="underline">[Unsplash API](https://unsplash.com/documentation#get-a-random-photo)</span> returning the photos array, with loading and error state

<CH.Spotlight>

```tsx useRandomPhotos.tsx
import { useState, useEffect } from 'react'

const useRandomPhotos = () => {
    const [data, setData] = useState<any>([])
    const [error, setError] = useState(null)
    const [isLoading, setIsLoading] = useState(false)

    useEffect(() => {
        setIsLoading(true)
        setData([])
        fetch(`https://api.unsplash.com/photos/random
          ?client_id=${import.meta.env.VITE_ACCESS_KEY}
          &count=4
          &topics=minimalism,wallpapers,nature,textures-patterns`)
            .then((res) => res.json())
            .then((data) => {
                setData(data)
                setIsLoading(false)
            })
            .catch((error) => {
                setError(error)
                setIsLoading(false)
            })
    }, [])

    return {
        photos: data.map((photo) => photo.urls.regular),
        error,
        isLoading
    }
}

export default useRandomPhotos
```

---

Selecting the topics and count from the API

```tsx useRandomPhotos.tsx focus=11:14

```

---

Handling Errors with hardcoded data (Unsplash API has a limit of 50 requests per hour)


```tsx useRandomPhotos.tsx focus=3:16,35:39,44
import { useState, useEffect } from 'react'

const dataIfError = [
    {
        "id": "0z-sWoAqs0c",
        "urls": {
            "raw": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3",
            "full": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=srgb&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=85",
            "regular": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=1080",
            "small": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=400",
            "thumb": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=200",
            "small_s3": "https://s3.us-west-2.amazonaws.com/images.unsplash.com/small/photo-1704500355467-88351c0797c3"
        },
        // ...
    }
]

const useRandomPhotos = () => {
    const [data, setData] = useState<any>([])
    const [error, setError] = useState(null)
    const [isLoading, setIsLoading] = useState(false)

    useEffect(() => {
        setIsLoading(true)
        setData([])
        fetch(`https://api.unsplash.com/photos/random
          ?client_id=${import.meta.env.VITE_ACCESS_KEY}
          &count=4
          &topics=minimalism,wallpapers,nature,textures-patterns`)
            .then((res) => res.json())
            .then((data) => {
                setData(data)
                setIsLoading(false)
            })
            .catch((error) => {
                setError(error)
                setIsLoading(false)
                setData(dataIfError)
            })
    }, [])

    return {
        photos: data.map((photo) => photo.urls.regular),
        error,
        isLoading
    }
}

export default useRandomPhotos
```

---

Handling background selection

```tsx useRandomPhotos.tsx focus=22:26,49,50
import { useState, useEffect } from 'react'

const dataIfError = [
    {
        "id": "0z-sWoAqs0c",
        "urls": {
            "raw": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3",
            "full": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=srgb&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=85",
            "regular": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=1080",
            "small": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=400",
            "thumb": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=200",
            "small_s3": "https://s3.us-west-2.amazonaws.com/images.unsplash.com/small/photo-1704500355467-88351c0797c3"
        },
        // ...
    }
]

const useRandomPhotos = () => {
    const [data, setData] = useState<any>([])
    const [error, setError] = useState(null)
    const [isLoading, setIsLoading] = useState(false)
    const [selectedBg, setSelectedBg] = useState('')

    const handleBgChange = (bg: string) => {
        setSelectedBg(bg)
    }

    useEffect(() => {
        setIsLoading(true)
        setData([])
        fetch(`https://api.unsplash.com/photos/random?client_id=${import.meta.env.VITE_ACCESS_KEY}&count=4&topics=minimalism,wallpapers,nature,textures-patterns`)
            .then((res) => res.json())
            .then((data) => {
                setData(data)
                setSelectedBg(data[0].urls.regular)
                setIsLoading(false)
            })
            .catch((error) => {
                setError(error)
                setIsLoading(false)
                setData(dataIfError)
            })
    }, [])

    return {
        photos: data.map((photo) => photo.urls.regular),
        error,
        isLoading,
        selectedBg,
        handleBgChange
    }
}

export default useRandomPhotos
```

---

Using the hook

<CH.Code>

```tsx useRandomPhotos.tsx
import { useState, useEffect } from 'react'

const dataIfError = [
    {
        "id": "0z-sWoAqs0c",
        "urls": {
            "raw": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3",
            "full": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=srgb&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=85",
            "regular": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=1080",
            "small": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=400",
            "thumb": "https://images.unsplash.com/photo-1704500355467-88351c0797c3?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3w1NDc0MTJ8MHwxfHJhbmRvbXx8fHx8fHx8fDE3MDQ4OTE3NzV8&ixlib=rb-4.0.3&q=80&w=200",
            "small_s3": "https://s3.us-west-2.amazonaws.com/images.unsplash.com/small/photo-1704500355467-88351c0797c3"
        },
        // ...
    }
]

const useRandomPhotos = () => {
    const [data, setData] = useState<any>([])
    const [error, setError] = useState(null)
    const [isLoading, setIsLoading] = useState(false)
    const [selectedBg, setSelectedBg] = useState('')

    const handleBgChange = (bg: string) => {
        setSelectedBg(bg)
    }

    useEffect(() => {
        setIsLoading(true)
        setData([])
        fetch(`https://api.unsplash.com/photos/random?client_id=${import.meta.env.VITE_ACCESS_KEY}&count=4&topics=minimalism,wallpapers,nature,textures-patterns`)
            .then((res) => res.json())
            .then((data) => {
                setData(data)
                setSelectedBg(data[0].urls.regular)
                setIsLoading(false)
            })
            .catch((error) => {
                setError(error)
                setIsLoading(false)
                setData(dataIfError)
            })
    }, [])

    return {
        photos: data.map((photo) => photo.urls.regular),
        error,
        isLoading,
        selectedBg,
        handleBgChange
    }
}

export default useRandomPhotos
```

---

```tsx AddBoard.tsx
import useRandomPhotos from "@/hooks/useRandomPhotos";

export default function AddBoard() {
  const { photos, isLoading, selectedBg, handleBgChange } = useRandomPhotos()

  return (
  {isLoading && (
      // Skeleton
  )}
  { !isLoading && (
      <div className="w-full flex-1 flex items-center flex-col gap-4">
          <div className="relative rounded-lg h-36 w-48 overflow-hidden">
              <img src={selectedBg} alt="" className="object-cover absolute w-full h-full shadow-md" />
              <Placeholder />
          </div>
          <div className="flex gap-2">
              {photos.map((bg, i) => (
                  <button
                      key={i}
                      className={cn('relative group rounded-md h-12 w-16 overflow-hidden transition', selectedBg === bg ? 'ring-2 ring-blue-500' : '')}
                      onClick={() => handleBgChange(bg)}
                  >
                      {selectedBg === bg && (
                          <div className="absolute z-20 inset-0 flex items-center justify-center">
                              <Check className="text-white/80 w-5 h-5" />
                          </div>
                      )}
                      <div className={cn("absolute hidden group-hover:block z-10 inset-0 bg-black/40 items-center justify-center", selectedBg === bg && 'block')} />
                      <img src={bg} alt="" className="object-cover absolute inset-0 w-full h-full shadow-md" />
                  </button>
              ))}
          </div>
      </div>
  )}
  )
}
```

</CH.Code>

</CH.Spotlight>

<br />
<h3 className="text-lg font-semibold">Mutation and Updating the Cache</h3>

<CH.Code>

```graphql create-board.mutation.graphql
mutation createBoard($title: String!, $description: String, $bg:String!){
  createBoard(title: $title, description: $description, bg:$bg){
    id
    title
    description
    bg
    updated_at
    saved
  }
}
```

```tsx AddBoard.tsx
import { useMutation } from "@apollo/client"
import {
    CreateBoardDocument,
    CreateBoardMutationVariables,
    CreateBoardMutation,
    AllBoardsDocument
} from "@/generated/graphql"
import { useNavigate } from "react-router-dom";

export default function AddBoard() {
  const navigate = useNavigate()
    
  const [createBoard] = useMutation<CreateBoardMutation, CreateBoardMutationVariables>(CreateBoardDocument, {
      onCompleted(data) {
          if (data.createBoard) {
              navigate(`/${data.createBoard.id}`)
          }
      },
      update: (cache, response) => {
          cache.updateQuery({ query: AllBoardsDocument }, (data) => {
              if (response.data?.createBoard) {
                  return {
                      allBoards: [response.data.createBoard, ...data.allBoards]
                  }
              }
              return data
          })
      }
  })
}
```

</CH.Code>
when mutation is completed `useNavigate` is used to redirect the user to the new board page and cache is immutably updated with the new board data using `updateQuery` on a successful response

<br />
<h2 className="text-2xl font-semibold">Using <span className="underline">[Codegen](https://the-guild.dev/graphql/codegen)</span> to generate typed queries and mutations</h2>

<CH.Code>

```bash
npm i -D @graphql-codegen/cli @graphql-codegen/typescript @graphql-codegen/typescript-graphql-request @graphql-codegen/typescript-operations @graphql-codegen/typescript-react-apollo
```
</CH.Code>

<h3 className="font-semibold">This will install the following packages as `devDepencencies`</h3>

<ul className="list ml-8">
<li>`@graphql-codegen/cli`</li>
<li>`@graphql-codegen/typescript`</li>
<li>`@graphql-codegen/typescript-graphql-request`</li>
<li>`@graphql-codegen/typescript-operations`</li>
<li>`@graphql-codegen/typescript-react-apollo`</li>
</ul>

<CH.Code>

```yml graphql.config.yml
schema:
  - "http://localhost:4000/"
documents:
  - "./src/graphql/*.graphql"
generates:
  ./src/generated/graphql.ts:
    plugins:
      - "typescript"
      - "typescript-operations"
      - "typescript-react-apollo"
```

</CH.Code>

<h3 className="font-semibold">The configuration file does the following:</h3>

<ul className="list ml-8">
<li>`schema` points to our GraphQL endpoint for fetching the API schema map.</li>
<li>`documents` tells GraphQL Codegen where to look for our schema files.</li>
<li>`generates` tells GraphQL Codegen where to create and store generated code.</li>
<li>`plugins` Specifies what GraphQL Codegen plugins to use.</li>
</ul>

<CH.Code>

```json package.json
{
  "scripts": {
    "generate": "graphql-codegen --config graphql.config.yml",
    "predev": "npm run generate"
  }
}
```

</CH.Code>

The `generate` script will run the codegen and generate the types in `./src/generated/graphql.ts`

<br />
<h2 className="text-2xl font-semibold">Optimistic UI</h2>

Handling optimistic updates was the most challenging part of the project, as it would feel weird when the user move or create a card/list and it disappears and reappears again after the response is received from the server.

It was achieved by passing the `optimisticResponse` object to the mutation options to the `useMutation` hook.

<CH.Code>

```tsx Board.tsx
const [addList] = useMutation<AddListMutation, AddListMutationVariables>(AddListDocument,{
  optimisticResponse: {
    __typename: "Mutation",
    addList: {
      __typename: "Board",
      id: id as string,
      title: data?.findBoard?.title as string,
      bg: data?.findBoard?.bg as string,
      description: data?.findBoard?.description as string,
      lists: [
        ...data?.findBoard?.lists as any[] || [],
        {
            __typename: "List",
            id: `temp-${Date.now()}`,
            title: listTitle,
            cards: []
        }
      ]
    }
  }
})
```

</CH.Code>

when the mutation happens the optimistic response is cached with a separate cache identifier to insure that our cached data remains accurate if the mutation fails,
and eventually when the server responds with the _actual_ resulting object the optimistic version is removed.

A temporary `id` is provided to be able to identify the object which is then replaced with the actual `id` from the server response.
This technique was used for most mutations in the project.

<br />
<h2 className="text-2xl font-semibold">Drag and Drop</h2>

Drag and drop was implemented using <span className="underline">[react-beautiful-dnd](https://github.com/atlassian/react-beautiful-dnd)</span> library which is maintained and relied on by Atlassian the company behind Trello.

I highly recommend this course by <span className="underline">[Alex Reardon](https://twitter.com/alexandereardon)</span> the creator of the library.
<br/>
<img src="https://og-image-react-egghead.vercel.app/playlists/beautiful-and-accessible-drag-and-drop-with-react-beautiful-dnd?v=20201103" alt="egghead react-beautiful-dnd course" className="rounded-lg shadow-lg" />
<div align="center">
  <a href="https://egghead.io/courses/beautiful-and-accessible-drag-and-drop-with-react-beautiful-dnd" className="text-blue-500 underline">egghead react-beautiful-dnd course</a>
</div>


<br />
<h2 className="text-2xl font-semibold">Dynamic Routes for Card Modals</h2>
<br />
<img src="https://utfs.io/f/3812f97a-99cc-4d32-a7cb-11c5f343e410-7ce0k0.PNG" alt="card modal" className="rounded-lg shadow-lg" />

<CH.Scrollycoding>

<h3 className="text-lg font-semibold">Displaying modal as an overlay</h3>

<p className="text-sm">When a modal is opened, the previous location is passed to `<Routes/>` instead of using the current location by default.</p>

```tsx App.tsx focus=3,4,9,14:18
export default function App() {
  const {token, setToken} = useTokenValue()
  const location = useLocation()
  const previousLocation = location.state?.previousLocation
  
  if (token) {
    return(
      <>
      <Routes location={previousLocation || location}>
        <Route path="/" element={<Home />} />
        <Route path="/:id" element={<Board />} />
      </Routes>

      {previousLocation && (
        <Routes>
          <Route path="/:id/:id" element={<CardModal previousLocation={previousLocation} />} />
        </Routes>
      )}
      </>
    )
  }

  return (
    // ...
  )
}

```

---

<h3 className="text-lg font-semibold">CardModal Component</h3>

<p className="text-sm">`useNavigate` Hook is used to redirect to the Board page when the modal is closed.</p>

```tsx CardModal.tsx
import { useNavigate } from 'react-router-dom';

export function CardModal({previousLocation}) {
  const navigate = useNavigate();
  return (
    <div
      onClick={() => navigate(`${previousLocation.pathname}`)}
    >
      <div
        onClick={e => e.stopPropagation()}
      >
        {/* Content */}
      </div>
    </div>
  );
}
```

---

<h3 className="text-lg font-semibold">Preventing the scroll underneath the modal</h3>

<p className="text-sm">
Using <span className="underline">[body-scroll-lock](https://www.npmjs.com/package/body-scroll-lock)</span> `disableBodyScroll` and `enableBodyScroll` functions when the modal component is mounted and unmounted, respectively. 
</p>


```tsx CardModal.tsx
import { useEffect, useRef } from "react";
import { useNavigate } from 'react-router-dom';
import { disableBodyScroll, enableBodyScroll } from 'body-scroll-lock';

export function CardModal({previousLocation}) {
  const modalRef = useRef();
  const navigate = useNavigate();

  useEffect(() => {
    const observerRefValue = modalRef.current;
    disableBodyScroll(observerRefValue);
    return () => {
      if (observerRefValue) {
        enableBodyScroll(observerRefValue);
      }
    };
  }, []);

  return (
    <div
      ref={modalRef}
      onClick={() => navigate(`${previousLocation.pathname}`)}
    >
      <div
        onClick={e => e.stopPropagation()}
      >
        {/* Content */}
      </div>
    </div>
  );
}
```



</CH.Scrollycoding>

